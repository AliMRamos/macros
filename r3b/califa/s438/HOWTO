Document generated by Hector Alvarez Pol @ USC (hector.alvarez@usc.es), 26/09/2014
Last update by Hector Alvarez Pol @ USC (hector.alvarez@usc.es), 26/09/2014
----------------------------------------------------------------------------------
EXPERIMENT s438


Description of the procedure for the calibration of the s438 data:

Hardware:   
	    - 2 petals: petal 1 (top, old petal) and 2 (bottom, new) 
	    - 128 crystals (from 0 to 63 in the petal 1, 64 to 127 in petal 2)
	    - 4 preamplifiers (32 channels each): 
	      0 for crystals 0 to 31
	      1 for crystals 32 to 63
	      2 for crystals 64 to 95
	      3 for crystals 96 to 127
	    - FEBEX numbers from 0 to 7
	      0 for crystals 0 to 15
	      1 for crystals 16 to 31
	      ...
	    - mapping table as in ???.txt 
	    (NOTE: not a correspondence between FEBEX channels and preamp channels)


Unpacking: (example with 10 files of run 140925, from 0100 to 0110, 22Na calib. run)
	   
	   In a working session of r3broot, directory r3broot/macros/r3b/califa/s438:
	   $ root -l
	   root [0] .L califaUnpack.C
	   root [1] run("na22_", 100, 110)
	   [INFO   ] 0 events, multiplicity:  1
	   ...
	   [INFO   ] 25281800 events, multiplicity:  1

	   Macro finished succesfully.
	   Output file is ./data/na22__raw.root
	   Parameter file is ./data/params_na22__raw.root
	   Real time 122.739 s, CPU time 120.81s
	   root [2] .q

	   Then, a new file r3broot/macros/r3b/califa/s438/data/na22__raw.root
	   contains the R3BCaloRawHit (rawHits for short)


Getting calibration parameters: (example with tun 140925, as before)

	Use the macro calibrate.C. A few parameters should be checked before, from
	the rawHits tree. In our case peaks are around 560 (for 511keV peak) and
	1370 (for 1274kev peak). Then, with windows (510,610) and (1320,1420):
	$ root -l
	root [0]  .L calibrate.C
	root [2] calibrate("./data/na22__raw.root",0,510,610,1320,1420)	
	Event:0
	Event:100000
	...
	
	The macro is not perfect (check the fits!). In this case 5 out of 256 fits failed 
	(this number could change as a function of the window opened around each peak).
	To correct those cases, check the parameters in fitPars_final.txt and modify 
	manually the lines corresponding to the fits, with your estimates; the file
	format is:
	line 1, crystal 0, first peak: gaus heigth, gaus mean, gaus sigma, baseline
	line 2, cyrstal 0, second peak:	gaus heigth, gaus mean, gaus sigma, baseline
	line 3, cyrstal 1, first peak: ...

	after modifying the 5 cases wrong with your estimates from the plots, convert the
	fitPars_final.txt into a fitPars_init.txt and run again in mode 1:
	mv fitPars_final.txt fitPars_init.txt
	$ root -l
	root [0]  .L calibrate.C
	root [2] calibrate("./data/na22__raw.root",1,510,610,1320,1420)	
	Event:0
	Event:100000
	...

	Check again all the fits! Save your results! (in this case to fitPars_140925.txt).

	To produce the gains and offsets from the fits results, as well as some additional
	information, run the macro extractParams.C.
	$ root -l
	root [0] .L extractParams.C
	root [1] extractParams("fitPars_140925.txt","calPars_140925.txt",
				"crystalInfo_140925.txt",510.998910,1274.53)
				(all in the same line!)

	The parameters will be at calPars_140925.txt and ore information in the file
	crystalInfo_140925.txt (resolution).


Adding the parameters:
       This step allow to enter the parameters in the adequate parameter container
       in R3BRoot for moving from RawHits to CrystalHits (R3BCaloCrystalHit).